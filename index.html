<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ç¬¬2è¯¾ - å¤§å®¶çš„æ—¥è¯­</title>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --mask-bg: #d1d1d6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 15px; text-align: center; background: #fff; font-weight: bold; border-bottom: 1px solid #ddd; z-index: 10; font-size: 1.1rem;}
        .container { flex: 1; padding: 15px; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; }
        .card { background: #fff; width: 100%; max-width: 500px; border-radius: 16px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; margin-bottom: 20px;}
        
        .tag { background: #e5e5ea; color: #666; padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px; display: inline-block; font-weight: bold;}

        /* === å¸ƒå±€ï¼šå·¦ä¾§æ’­æ”¾é’® + å³ä¾§å†…å®¹ === */
        .dialogue-row { display: flex; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        
        /* å·¦ä¾§æ’­æ”¾æŒ‰é’®åŒºåŸŸ */
        .play-col { width: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 10px; padding-top: 5px; }
        
        .play-icon { font-size: 1.4rem; color: var(--primary); cursor: pointer; background: #eef7ff; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .play-icon:active { background: #007aff; color: white; transform: scale(0.9); }

        /* å³ä¾§æ–‡å­—åŒºåŸŸ */
        .text-col { flex: 1; text-align: left; }

        /* è§’è‰²æ ‡ç­¾ */
        .role-tag { font-size: 0.7rem; font-weight: bold; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px; vertical-align: middle; display: inline-block; margin-bottom: 4px;}
        .role-m { background-color: #5856d6; } /* ç”·å£°é¢œè‰² */
        .role-f { background-color: #ff2d55; } /* å¥³å£°é¢œè‰² */

        /* é®æŒ¡æ¡æ ·å¼ */
        .text-block { transition: all 0.2s; border-radius: 6px; padding: 6px 8px; cursor: pointer; display: block; margin-bottom: 6px; line-height: 1.5; border: 1px solid transparent; }

        /* é®æŒ¡çŠ¶æ€ */
        .masked { background-color: var(--mask-bg); color: transparent !important; position: relative; border-color: transparent; }
        .masked::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: #999; border-radius: 50%; }

        /* æ–‡å­—å·²æ˜¾ç¤ºçŠ¶æ€ */
        .jp-text { font-size: 1.15rem; font-weight: bold; color: #000; }
        .cn-text { font-size: 0.95rem; color: #666; }

        /* é«˜äº®æ’­æ”¾ä¸­ */
        .playing-row { background-color: #f0f9ff; border-radius: 8px; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls { padding: 15px; background: #fff; border-top: 1px solid #ddd; flex-shrink: 0;}
        .row { display: flex; gap: 10px; margin-bottom: 8px; }
        button { border: none; padding: 12px; border-radius: 10px; font-size: 0.95rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center;}
        
        .btn-green { background: #34c759; color: white; width: 100%; font-size: 1rem; margin-bottom: 10px; padding: 14px;}
        .btn-green:active { background: #248a3d; }
        
        .btn-nav { background: #eee; color: #333; flex: 1; }
        .btn-toggle { background: #fff; border: 1px solid #ccc; color: #333; flex: 1; }
        .btn-toggle.active { background: #007aff; color: white; border: none; }

        #status-bar { font-size: 10px; color: #999; text-align: center; margin-top: 5px; height: 15px;}
    </style>
</head>
<body>

    <div class="header" id="headerTitle">ç¬¬2è¯¾</div>

    <div class="container">
        <div id="cardArea" class="card"></div>
    </div>

    <div class="controls">
        <div id="status-bar">å‡†å¤‡å°±ç»ª</div>
        <div class="row">
            <button class="btn-toggle" id="btnJp" onclick="toggleGlobal('jp')">å…¨æ˜¾æ—¥æ–‡</button>
            <button class="btn-toggle" id="btnCn" onclick="toggleGlobal('cn')">å…¨æ˜¾ä¸­æ–‡</button>
        </div>
        <div class="row">
            <button class="btn-nav" onclick="changeCard(-1)">â¬…ï¸ ä¸Šä¸€æ¡</button>
            <button class="btn-nav" onclick="changeCard(1)">ä¸‹ä¸€æ¡ â¡ï¸</button>
        </div>
    </div>

    <script>
        // ===============================================
        // æ•°æ®åŒºï¼šç¬¬2è¯¾
        // ===============================================
        const lessonData = [
            // --- ä¾‹æ–‡ (Reibun) 1-8 ---
            { 
                category: 'ä¾‹æ–‡ 1', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ã“ã‚Œã¯ ãƒœãƒ¼ãƒ«ãƒšãƒ³ã§ã™ã‹ã€‚', cn: 'è¿™æ˜¯åœ†ç ç¬”å—ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã¯ã„ã€ãã†ã§ã™ã€‚', cn: 'â€¦â€¦æ˜¯çš„ï¼Œæ˜¯åœ†ç ç¬”ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 2', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ãã‚Œã¯ ãƒãƒ¼ãƒˆã§ã™ã‹ã€‚', cn: 'é‚£æ˜¯ç¬”è®°æœ¬å—ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã„ã„ãˆã€[ã“ã‚Œã¯] æ‰‹å¸³ã§ã™ã€‚', cn: 'â€¦â€¦ä¸ï¼Œ[è¿™æ˜¯] è®°äº‹æœ¬ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 3', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ãã‚Œã¯ ä½•ã§ã™ã‹ã€‚', cn: 'é‚£æ˜¯ä»€ä¹ˆï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦[ã“ã‚Œã¯] ååˆºã§ã™ã€‚', cn: 'â€¦â€¦[è¿™æ˜¯] åç‰‡ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 4', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ã“ã‚Œã¯ ã€Œ9ã€ã§ã™ã‹ã€ã€Œ7ã€ã§ã™ã‹ã€‚', cn: 'è¿™æ˜¯â€œ9â€è¿˜æ˜¯â€œ7â€ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã€Œ9ã€ã§ã™ã€‚', cn: 'â€¦â€¦æ˜¯â€œ9â€ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 5', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ãã‚Œã¯ ä½•ã® é›‘èªŒã§ã™ã‹ã€‚', cn: 'é‚£æ˜¯ä»€ä¹ˆå†…å®¹çš„æ‚å¿—ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã® é›‘èªŒã§ã™ã€‚', cn: 'â€¦â€¦æ˜¯è®¡ç®—æœºæ‚å¿—ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 6', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ã‚ã‚Œã¯ ã ã‚Œã® ã‹ã°ã‚“ã§ã™ã‹ã€‚', cn: 'é‚£æ˜¯ä¸ªè°çš„åŒ…ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ä½è—¤ã•ã‚“ã® ã‹ã°ã‚“ã§ã™ã€‚', cn: 'â€¦â€¦æ˜¯ä½è—¤å…ˆç”Ÿ/å¥³å£«çš„åŒ…ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 7', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ã“ã‚Œã¯ ãƒŸãƒ©ãƒ¼ã•ã‚“ã®ã§ã™ã‹ã€‚', cn: 'è¿™æ˜¯ç±³å‹’å…ˆç”Ÿçš„å—ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã„ã„ãˆã€ã‚ãŸã—ã®ã˜ã‚ƒ ã‚ã‚Šã¾ã›ã‚“ã€‚', cn: 'â€¦â€¦ä¸ï¼Œä¸æ˜¯æˆ‘çš„ã€‚' }
                ]
            },
            { 
                category: 'ä¾‹æ–‡ 8', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ã“ã® ã‹ãã¯ ã ã‚Œã®ã§ã™ã‹ã€‚', cn: 'è¿™æŠŠé’¥åŒ™æ˜¯è°çš„ï¼Ÿ' },
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã‚ãŸã—ã®ã§ã™ã€‚', cn: 'â€¦â€¦æ˜¯æˆ‘çš„ã€‚' }
                ]
            },

            // --- ä¼šè¯ (Kaiwa) ---
            {
                category: 'ä¼šè¯ï¼šä»æ­¤æ‰¿è’™æ‚¨ç…§é¡¾', // ã“ã‚Œã‹ã‚‰ ãŠä¸–è©±ã« ãªã‚Šã¾ã™
                lines: [
                    // åœºæ™¯ï¼šSantos æ•²é—¨
                    { role: 'å±±ç”°ä¸€éƒ', gender: 'm', jp: 'ã¯ã„ã€‚ã©ãªãŸã§ã™ã‹ã€‚', cn: 'æ¥äº†ã€‚å“ªä½ï¼Ÿ' },
                    { role: 'ã‚µãƒ³ãƒˆã‚¹', gender: 'm', jp: '408ã® ã‚µãƒ³ãƒˆã‚¹ã§ã™ã€‚', cn: 'æˆ‘æ˜¯408å®¤çš„æ¡‘æ‰˜æ–¯ã€‚' },
                    // åœºæ™¯ï¼šé—¨å¼€äº†
                    { role: 'ã‚µãƒ³ãƒˆã‚¹', gender: 'm', jp: 'ã“ã‚“ã«ã¡ã¯ã€‚ã‚µãƒ³ãƒˆã‚¹ã§ã™ã€‚', cn: 'ä½ å¥½ã€‚æˆ‘æ˜¯æ¡‘æ‰˜æ–¯ã€‚' },
                    { role: 'ã‚µãƒ³ãƒˆã‚¹', gender: 'm', jp: 'ã“ã‚Œã‹ã‚‰ ãŠä¸–è©±ã« ãªã‚Šã¾ã™ã€‚', cn: 'ä»Šåè¯·ä½ å¤šå…³ç…§ã€‚' },
                    { role: 'ã‚µãƒ³ãƒˆã‚¹', gender: 'm', jp: 'ã©ã†ã ã‚ˆã‚ã—ã ãŠé¡˜ã„ã—ã¾ã™ã€‚', cn: 'è¯·å¤šå¤šæŒ‡æ•™ã€‚' },
                    { role: 'å±±ç”°ä¸€éƒ', gender: 'm', jp: 'ã“ã¡ã‚‰ã“ã ã‚ˆã‚ã—ã ãŠé¡˜ã„ã—ã¾ã™ã€‚', cn: 'å“ªé‡Œå“ªé‡Œï¼Œä¹Ÿè¯·ä½ å¤šå¤šæŒ‡æ•™ã€‚' },
                    { role: 'ã‚µãƒ³ãƒˆã‚¹', gender: 'm', jp: 'ã‚ã®ã†ã€ã“ã‚Œã€ã‚³ãƒ¼ãƒ’ãƒ¼ã§ã™ã€‚ã©ã†ãã€‚', cn: 'é‚£ä¸ªâ€¦â€¦è¿™ç‚¹å¿ƒæ„ï¼Œæ˜¯å’–å•¡ã€‚è¯·æ”¶ä¸‹ã€‚' },
                    { role: 'å±±ç”°ä¸€éƒ', gender: 'm', jp: 'ã©ã†ã‚‚ ã‚ã‚ŠãŒã¨ã† ã”ã–ã„ã¾ã™ã€‚', cn: 'éå¸¸æ„Ÿè°¢ã€‚' }
                ]
            }
        ];

        // ================= çŠ¶æ€ç®¡ç† =================
        let currentIndex = 0;
        let globalShowJp = false;
        let globalShowCn = false;
        let isSeqPlaying = false;
        let voices = { male: null, female: null, default: null };

        // ================= è¯­éŸ³å¼•æ“ =================
        function loadVoices() {
            const all = window.speechSynthesis.getVoices();
            const ja = all.filter(v => v.lang.includes('ja'));
            if (ja.length > 0) {
                // å°è¯•åŒºåˆ†ç”·å¥³å£°
                voices.female = ja.find(v => v.name.includes('Kyoko') || v.name.includes('Female')) || ja[0];
                voices.male = ja.find(v => v.name.includes('Otoya') || v.name.includes('Male')) || ja[0];
                voices.default = ja[0];
                document.getElementById('status-bar').innerText = "âœ… è¯­éŸ³åŠ è½½å®Œæˆ";
            } else {
                document.getElementById('status-bar').innerText = "âš ï¸ ä½¿ç”¨é»˜è®¤è¯­éŸ³";
            }
        }
        if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadVoices;
        setTimeout(loadVoices, 500);

        function speak(text, gender, callback) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 0.9;
            
            // é€‰æ‹©å£°éŸ³
            if (gender === 'm' && voices.male) u.voice = voices.male;
            else if (gender === 'f' && voices.female) u.voice = voices.female;
            else if (voices.default) u.voice = voices.default;

            // æ¨¡æ‹ŸéŸ³è°ƒå·®å¼‚
            if (gender === 'm') u.pitch = 0.95; 
            else u.pitch = 1.1;

            if (callback) u.onend = callback;
            window.speechSynthesis.speak(u);
        }

        // ================= æ¸²æŸ“é€»è¾‘ =================
        function render() {
            window.speechSynthesis.cancel();
            isSeqPlaying = false;
            
            const data = lessonData[currentIndex];
            document.getElementById('headerTitle').innerText = `${data.category} (${currentIndex + 1}/${lessonData.length})`;
            
            updateGlobalBtns();

            let html = `<div class="tag">${data.category}</div>`;
            
            html += `<button class="btn-green" onclick="playSequence()">â–¶ï¸ å®Œæ•´æ’­æ”¾ (åŒ…å«åœé¡¿)</button>`;
            
            html += `<div style="text-align:left; width:100%;">`;

            data.lines.forEach((line, idx) => {
                const jpClass = globalShowJp ? 'text-block jp-text' : 'text-block jp-text masked';
                const cnClass = globalShowCn ? 'text-block cn-text' : 'text-block cn-text masked';
                const roleClass = line.gender === 'm' ? 'role-m' : 'role-f';

                html += `
                    <div class="dialogue-row" id="row-${idx}">
                        <div class="play-col">
                            <div class="play-icon" onclick="playLine(${idx})">ğŸ”Š</div>
                        </div>
                        <div class="text-col">
                            ${line.role ? `<span class="role-tag ${roleClass}">${line.role}</span>` : ''}
                            <div class="${jpClass}" onclick="toggleOne(this)">${line.jp}</div>
                            <div class="${cnClass}" onclick="toggleOne(this)">${line.cn}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            
            document.getElementById('cardArea').innerHTML = html;
        }

        // ================= äº¤äº’é€»è¾‘ =================
        function toggleOne(el) {
            if (el.classList.contains('masked')) {
                el.classList.remove('masked');
            } else {
                el.classList.add('masked');
            }
        }

        function toggleGlobal(type) {
            if (type === 'jp') globalShowJp = !globalShowJp;
            if (type === 'cn') globalShowCn = !globalShowCn;
            render();
        }

        function updateGlobalBtns() {
            const bJ = document.getElementById('btnJp');
            const bC = document.getElementById('btnCn');
            bJ.className = globalShowJp ? 'btn-toggle active' : 'btn-toggle';
            bC.className = globalShowCn ? 'btn-toggle active' : 'btn-toggle';
            bJ.innerText = globalShowJp ? 'å…¨æ˜¾æ—¥æ–‡' : 'å…¨éšæ—¥æ–‡';
            bC.innerText = globalShowCn ? 'å…¨æ˜¾ä¸­æ–‡' : 'å…¨éšä¸­æ–‡';
        }

        function playLine(idx) {
            isSeqPlaying = false;
            highlightRow(idx);
            
            const data = lessonData[currentIndex];
            const line = data.lines[idx];
            speak(line.jp, line.gender, () => {
                unhighlightRow(idx);
            });
        }

        function playSequence() {
            isSeqPlaying = true;
            const data = lessonData[currentIndex];
            let idx = 0;
            
            document.querySelectorAll('.dialogue-row').forEach(e => e.classList.remove('playing-row'));

            function next() {
                if (!isSeqPlaying || idx >= data.lines.length) {
                    isSeqPlaying = false;
                    if(idx > 0) unhighlightRow(idx-1);
                    return;
                }

                if (idx > 0) unhighlightRow(idx-1);
                highlightRow(idx);
                
                document.getElementById(`row-${idx}`).scrollIntoView({behavior: "smooth", block: "center"});

                const line = data.lines[idx];
                speak(line.jp, line.gender, () => {
                    idx++;
                    setTimeout(next, 600); 
                });
            }
            next();
        }

        function highlightRow(idx) {
            const el = document.getElementById(`row-${idx}`);
            if (el) el.classList.add('playing-row');
        }
        function unhighlightRow(idx) {
            const el = document.getElementById(`row-${idx}`);
            if (el) el.classList.remove('playing-row');
        }

        function changeCard(dir) {
            const next = currentIndex + dir;
            if (next >= 0 && next < lessonData.length) {
                currentIndex = next;
                render();
            }
        }

        render();

    </script>
</body>
</html>
